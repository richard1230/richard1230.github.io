---
title: useEffect
date: 02-06-2022 
categories:
- React 
tags:
- React
---


## pure function and impure function

>å‡½æ•°ä¸å¤–ç•Œäº¤æµæ•°æ®åªæœ‰ä¸€ä¸ªå”¯ä¸€æ¸ é“:
>å‚æ•°å’Œè¿”å›å€¼ã€‚


çº¯å‡½æ•°ï¼ˆPure functionï¼‰:è¿”å›ç»“æœåªä¾èµ–äºå®ƒçš„å‚æ•°ï¼Œè€Œä¸”æ²¡æœ‰ä»»ä½•å¯è§‚å¯Ÿçš„å‰¯ä½œç”¨;

- ç»™çº¯å‡½æ•°ä¼ å…¥ç›¸åŒçš„å‚æ•°ï¼Œæ°¸è¿œä¼šè¿”å›ç›¸åŒçš„å€¼ã€‚å¦‚æœè¿”å›å€¼ä¾èµ–å¤–éƒ¨å˜é‡ï¼Œåˆ™ä¸æ˜¯çº¯å‡½æ•°ã€‚

```javascript
//pure function
//çº¯å‡½æ•°  ä¸ç®¡å¤–éƒ¨å¦‚ä½•å¤©ç¿»åœ°è¦†ï¼Œåªè¦ä¼ å…¥çš„å‚æ•°æ˜¯ç¡®å®šçš„ï¼Œé‚£ä¹ˆå€¼æ°¸è¿œæ˜¯å¯é¢„æ–™çš„
function purefuncA(a,b){
  return a+b
}
purefuncA(1,5)//6

//// éçº¯å‡½æ•°  è¿”å›å€¼ä¹Ÿä¾èµ–å¤–éƒ¨å˜é‡cï¼Œç»“æœæ— æ³•é¢„æ–™
//impure function
let c = 3;
const funcA = (a,b)=>{
  return a+b+c
}

funcA(2,4)//9
let c = 5;

funcA(2,4)//11
```
- ä¸€ä¸ªå‡½æ•°åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­äº§ç”Ÿäº†å¤–éƒ¨å¯è§‚å¯Ÿçš„å˜åŒ–ï¼Œåˆ™è¿™ä¸ªå‡½æ•°æ˜¯æœ‰å‰¯ä½œç”¨(Side Effect)çš„ã€‚
>é€šä¿—ç‚¹å°±æ˜¯å‡½æ•°å†…éƒ¨åšäº†å’Œè¿ç®—è¿”å›å€¼æ— å…³çš„äº‹ï¼Œæ¯”å¦‚ä¿®æ”¹å¤–éƒ¨ä½œç”¨åŸŸ/å…¨å±€å˜é‡ã€ä¿®æ”¹ä¼ å…¥çš„å‚æ•°ã€å‘é€è¯·æ±‚ã€console.logã€æ‰‹åŠ¨ä¿®æ”¹ DOM éƒ½å±äºå‰¯ä½œç”¨ã€‚


çº¯å‡½æ•°å¾ˆä¸¥æ ¼ï¼Œå‡ ä¹é™¤äº†è®¡ç®—æ•°æ®ä»€ä¹ˆéƒ½ä¸èƒ½å¹²ï¼Œè®¡ç®—çš„æ—¶å€™è¿˜ä¸èƒ½ä¾èµ–è‡ªèº«å‚æ•°ä»¥å¤–çš„æ•°æ®ã€‚


>å°ç»“:
>æ»¡è¶³çº¯å‡½æ•°å°±æ˜¯è¦æ»¡è¶³ä¸¤ç‚¹:<br>
>1.å‡½æ•°è¿”å›ç»“æœåªä¾èµ–å®ƒçš„å‚æ•°ã€‚<br>
>2.å‡½æ•°æ‰§è¡Œè¿‡ç¨‹ä¸­ä¸ä¼šå¯¹å¤–äº§ç”Ÿå¯è§‚å¯Ÿçš„å˜åŒ–ã€‚<br>



## é—­åŒ…é™·é˜±é—®é¢˜(Closure trap)
Look at the code below:
```jsx
import { useEffect, useState } from 'react';

function App() {

    const [count,setCount] = useState(0);

    useEffect(() => {
        setInterval(() => {
            setCount(count + 1);
        }, 500);
    }, []);

    useEffect(() => {
        setInterval(() => {
            console.log(count);
        }, 500);
    }, []);

    return <div>Hello</div>;
}

export default App;

```

ç”¨ useState åˆ›å»ºäº†ä¸ª count çŠ¶æ€ï¼Œåœ¨ä¸€ä¸ª useEffect é‡Œå®šæ—¶ä¿®æ”¹å®ƒï¼Œå¦ä¸€ä¸ª useEffect é‡Œå®šæ—¶æ‰“å°æœ€æ–°çš„ count å€¼ã€‚

running:

![closure-trap](../../assets/images/closure_trap.png)

æ‰“å°çš„å¹¶ä¸æ˜¯æˆ‘ä»¬é¢„æœŸçš„ 0ã€1ã€2ã€3ï¼Œè€Œæ˜¯ 0ã€0ã€0ã€0ï¼Œè¿™æ˜¯ä¸ºä»€ä¹ˆå‘¢ï¼Ÿ

è¿™å°±æ˜¯æ‰€è°“çš„é—­åŒ…é™·é˜±ã€‚

é€šè¿‡æŸ¥çœ‹åº•å±‚æºç å¾—çŸ¥:
`areHookInputsEqual(nextDeps,preDeps)`è¿™ä¸ªå‡½æ•°ä¼šæ¯”è¾ƒå‰åçš„deps,
å¦‚æœæ˜¯ç©ºæ•°ç»„,å¯¼è‡´areHookInputsEqual(nextDeps,preDeps)è¿™ä¸ªå‡½æ•°è¿”å›å€¼ä¸ºFALSE;
å¯¼è‡´ä¸æ‰§è¡Œå›è°ƒå‡½æ•°,æ­¤æ—¶åªæ‰§è¡Œä¸€æ¬¡å›è°ƒ;è¿™åˆä¼šå¯¼è‡´ä»€ä¹ˆ?

useEffect ç­‰ hook é‡Œç”¨åˆ°äº†æŸä¸ª stateï¼Œä½†æ˜¯æ²¡æœ‰åŠ åˆ° deps æ•°ç»„é‡Œï¼Œè¿™æ ·å¯¼è‡´ state å˜äº†å´æ²¡æœ‰æ‰§è¡Œæ–°ä¼ å…¥çš„å‡½æ•°ï¼Œä¾ç„¶å¼•ç”¨çš„ä¹‹å‰çš„ state(ä¸ºä»€ä¹ˆå¼•ç”¨çš„æ˜¯ä¹‹å‰çš„stateè§ä¸Š)ã€‚

## Fix
é—­åŒ…é™·é˜±çš„è§£å†³ä¹Ÿå¾ˆç®€å•ï¼Œæ­£ç¡®è®¾ç½® deps æ•°ç»„å°±å¯ä»¥äº†ï¼Œè¿™æ ·æ¯æ¬¡ç”¨åˆ°çš„ state å˜äº†å°±ä¼šæ‰§è¡Œæ–°å‡½æ•°ï¼Œå¼•ç”¨æ–°çš„ stateã€‚ä¸è¿‡è¿˜è¦æ³¨æ„è¦æ¸…ç†ä¸‹ä¸Šæ¬¡çš„å®šæ—¶å™¨ã€äº‹ä»¶ç›‘å¬å™¨ç­‰ã€‚


```jsx
import { useEffect, useState } from 'react';

function Dong() {

    const [count,setCount] = useState(0);

    useEffect(() => {
        const timer = setInterval(() => {
            setCount(count + 1);
        }, 500);
        return () => clearInterval(timer);
    }, [count]);

    useEffect(() => {
        const timer = setInterval(() => {
            console.log(count);
        }, 500);
        return () => clearInterval(timer);
    }, [count]);

    return <div>guang</div>;
}

export default Dong;
```

## useEffectçš„æ‰§è¡Œé¡ºåº
```jsx

function Child() {
  useEffect(() => {
    console.log('child');
  }, [])

  return <p>hello</p>;
}

function Parent() {
  useEffect(() => {
    console.log('parent');
  }, [])

  return <Child/>;
}

function App() {
  useEffect(() => {
    console.log('app');
  }, [])

  return <Parent/>;
}
```
æ¸²æŸ“<App/>æ—¶æ§åˆ¶å°çš„æ‰“å°é¡ºåºæ˜¯ï¼Ÿ
```
ğŸ‘‰                              child -> parent -> app

```
why?

Reactçš„æºç å¯ä»¥æ‹†åˆ†ä¸ºä¸‰å—ï¼š

- è°ƒåº¦å™¨ï¼šè°ƒåº¦æ›´æ–°
- åè°ƒå™¨ï¼šå†³å®šæ›´æ–°çš„å†…å®¹
- æ¸²æŸ“å™¨ï¼šå°†æ›´æ–°çš„å†…å®¹æ¸²æŸ“åˆ°è§†å›¾ä¸­


å…¶ä¸­ï¼Œåªæœ‰`æ¸²æŸ“å™¨`ä¼šæ‰§è¡Œæ¸²æŸ“è§†å›¾æ“ä½œã€‚

å¯¹äºæµè§ˆå™¨ç¯å¢ƒæ¥è¯´ï¼Œåªæœ‰`æ¸²æŸ“å™¨`ä¼šæ‰§è¡Œç±»ä¼¼`appendChild`ã€`insertBefore`è¿™æ ·çš„DOMæ“ä½œã€‚

`åè°ƒå™¨`å¦‚ä½•å†³å®šæ›´æ–°çš„å†…å®¹å‘¢ï¼Ÿ

ç­”æ¡ˆæ˜¯ï¼šä»–ä¼šä¸ºéœ€è¦æ›´æ–°çš„å†…å®¹å¯¹åº”çš„`fiber`ï¼ˆå¯ä»¥ç†è§£ä¸º`è™šæ‹ŸDOMï¼‰æ‰“ä¸Šæ ‡è®°ã€‚

è¿™äº›è¢«æ‰“æ ‡è®°çš„`fiber`ä¼šå½¢æˆä¸€æ¡é“¾è¡¨`effectList`ã€‚

`æ¸²æŸ“å™¨`ä¼šéå†`effectList`ï¼Œæ‰§è¡Œæ ‡è®°å¯¹åº”çš„æ“ä½œã€‚

æ¯”å¦‚`Placement`æ ‡è®°å¯¹åº”æ’å…¥`DOM`

æ¯”å¦‚`Update`æ ‡è®°å¯¹åº”æ›´æ–°DOMå±æ€§

`useEffect`ä¹Ÿéµå¾ªåŒæ ·çš„å·¥ä½œåŸç†ï¼š

- è§¦å‘æ›´æ–°æ—¶ï¼Œ`FunctionComponent`è¢«æ‰§è¡Œï¼Œæ‰§è¡Œåˆ°`useEffect`æ—¶ä¼šåˆ¤æ–­ä»–çš„ç¬¬äºŒä¸ªå‚æ•°`deps`æ˜¯å¦æœ‰å˜åŒ–ã€‚

- å¦‚æœ`dep`så˜åŒ–ï¼Œåˆ™`useEffect`å¯¹åº”`FunctionComponent`çš„`fiber`ä¼šè¢«æ‰“ä¸Š`Passive`ï¼ˆå³ï¼šéœ€è¦æ‰§è¡Œ`useEffect`ï¼‰çš„æ ‡è®°ã€‚

- åœ¨æ¸²æŸ“å™¨ä¸­ï¼Œéå†`effectList`è¿‡ç¨‹ä¸­éå†åˆ°è¯¥fiberæ—¶ï¼Œå‘ç°`Passive`æ ‡è®°ï¼Œåˆ™ä¾æ¬¡æ‰§è¡Œè¯¥`useEffect`çš„`destroy`ï¼ˆå³useEffectå›è°ƒå‡½æ•°çš„è¿”å›å€¼å‡½æ•°ï¼‰ä¸createï¼ˆå³useEffectå›è°ƒå‡½æ•°ï¼‰ã€‚

å…¶ä¸­ï¼Œå‰ä¸¤æ­¥å‘ç”Ÿåœ¨åè°ƒå™¨ä¸­ã€‚

æ‰€ä»¥ï¼Œ`effectList`æ„å»ºçš„é¡ºåºå°±æ˜¯useEffectçš„æ‰§è¡Œé¡ºåºã€‚

### effectList
`åè°ƒå™¨`çš„å·¥ä½œæµç¨‹æ˜¯ä½¿ç”¨éå†å®ç°çš„`é€’å½’`ã€‚æ‰€ä»¥å¯ä»¥åˆ†ä¸º`é€’`ä¸`å½’`ä¸¤ä¸ªé˜¶æ®µã€‚

æˆ‘ä»¬çŸ¥é“ï¼Œ`é€’`æ˜¯ä»æ ¹èŠ‚ç‚¹å‘ä¸‹ä¸€ç›´åˆ°å¶å­èŠ‚ç‚¹ï¼Œ`å½’`æ˜¯ä»å¶å­èŠ‚ç‚¹ä¸€è·¯å‘ä¸Šåˆ°æ ¹èŠ‚ç‚¹ã€‚

>`effectList`çš„æ„å»ºå‘ç”Ÿåœ¨å½’é˜¶æ®µã€‚æ‰€ä»¥ï¼Œ`effectList`çš„é¡ºåºä¹Ÿæ˜¯ä»å¶å­èŠ‚ç‚¹ä¸€è·¯å‘ä¸Šã€‚

`useEffect`å¯¹åº”`fiber`ä½œä¸º`effectList`ä¸­çš„ä¸€ä¸ªèŠ‚ç‚¹ï¼Œä»–çš„è°ƒç”¨é€»è¾‘ä¹Ÿéµå¾ªå½’çš„æµç¨‹ã€‚

ç°åœ¨ï¼Œæˆ‘ä»¬æœ‰å……è¶³çš„çŸ¥è¯†å›ç­”ç¬¬ä¸€ä¸ªé—®é¢˜ï¼š

ç”±äºå½’é˜¶æ®µæ˜¯ä»`Child`åˆ°`Parent`åˆ°`App`ï¼Œæ‰€ä»¥ç›¸åº”`effectList`ä¹Ÿæ˜¯åŒæ ·çš„é¡ºåºã€‚

æ‰€ä»¥`useEffect`å›è°ƒå‡½æ•°æ‰§è¡Œä¹Ÿæ˜¯åŒæ ·çš„é¡ºåºã€‚


### æ¸²æŸ“
`React`çš„æ‰§è¡Œéµå¾ªï¼š
```
è°ƒåº¦ -- åè°ƒ -- æ¸²æŸ“

```
æ¸²æŸ“ç›¸å…³å·¥ä½œåŸç†æ˜¯æŒ‰ç…§ï¼š

```
æ„å»ºeffectList -- éå†effectListæ‰§è¡Œå¯¹åº”æ“ä½œ


```

`effectList`ä¼šåœ¨æ¸²æŸ“å™¨ä¸­è¢«å¤„ç†ã€‚

å¯¹äº`useEffect`æ¥è¯´ï¼Œéå†`effectList`æ—¶ï¼Œä¼šæ‰¾åˆ°çš„æ‰€æœ‰åŒ…å«`Passive`æ ‡è®°çš„`fiber`ã€‚

ä¾æ¬¡æ‰§è¡Œå¯¹åº”`useEffectçš„destroy`ã€‚

æ‰€æœ‰`destroy`æ‰§è¡Œå®Œåï¼Œå†ä¾æ¬¡æ‰§è¡Œæ‰€æœ‰`create`ã€‚

æ•´ä¸ªè¿‡ç¨‹æ˜¯åœ¨é¡µé¢æ¸²æŸ“åå¼‚æ­¥æ‰§è¡Œçš„ã€‚

çœ‹ä¸€ä¸ªé—®é¢˜:
```jsx
// componentDidMountç”Ÿå‘½å‘¨æœŸé’©å­
class App extends React.Component {
  componentDidMount() {
    console.log('hello');
  }
}

// ä¾èµ–ä¸º[]çš„useEffect
useEffect(() => {
  console.log('hello');
}, [])
```
ä¸¤ä¸ªå›è°ƒå‡½æ•°çš„è°ƒç”¨æ—¶æœºç›¸åŒä¹ˆ?
å¦‚æœ`useEffectçš„deps`ä¸º`[]`ï¼Œç”±äº`deps`ä¸ä¼šæ”¹å˜ï¼Œå¯¹åº”`fiber`åªä¼šåœ¨`mount`æ—¶è¢«æ ‡è®°`Passive`ã€‚

è¿™ç‚¹æ˜¯ç±»ä¼¼componentDidMountçš„ã€‚


ä½†æ˜¯ï¼Œå¤„ç†`Passive effect`æ˜¯åœ¨æ¸²æŸ“å®Œæˆåå¼‚æ­¥æ‰§è¡Œï¼Œè€Œ`componentDidMount`æ˜¯åœ¨æ¸²æŸ“å®ŒæˆååŒæ­¥æ‰§è¡Œï¼Œæ‰€ä»¥ä»–ä»¬æ˜¯ä¸åŒçš„ã€‚










## å‚è€ƒ

https://mp.weixin.qq.com/s/0P7eWSNQNKWroDIlcgHBVw

https://mp.weixin.qq.com/s/a25xf4AEwJXT7Ubvo6AL6g

https://overreacted.io/zh-hans/a-complete-guide-to-useeffect/